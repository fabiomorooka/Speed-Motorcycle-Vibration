function [] = FRFSimNv2b(varargin)
% This is a script file to show the FRFs of a NDOF system
% given the mass, damping and stiffness matrices. It also 
% shows the animated mode shapes. 
%
% Developed by Prof. Dr. Milton Dias Junior
%              Department of Mechanical Design
%              Faculty of Mechanical Engineering
%              State University of Campinas
%              S?o Paulo - Brazil
%              milton@fem.unicamp.br
%              August 31st, 2001
% Present version adapted on November 6th, 2008
%    

clc
set(0,'Units','normalized');
screenrect = get(0,'screensize');
screenwidth = screenrect(3);
screenheigth = screenrect(4);
fig.width   = .9;
fig.heigth  = .7;
fig.left    = (screenwidth-fig.width)/2;
fig.bottom  = (screenheigth-fig.heigth)/2;
FIGPOSIT    = [fig.left fig.bottom fig.width fig.heigth];

[SnapData] = SnapshotCData;

COrder = [ 0    0    1.00
    0    0.75 0.75
    1.00 0    0
    0    0.50 0
    0.75 0    0.75
    0.75 0.75 0
    0.25 0.25 0.25];
FigPosUpper = [.35 .55 .63 .35];
FigPosLower = [.35 .1 .63 .35];
FigPosNyqui = [.40 .1 .53 .8];

FrameColor = [.60 .7 .74];
BackGColor = [.70 .8 .84];

DampV   = {'0.00';'0.01';'0.05';'0.10';'0.20';'0.30';'0.40';'0.50';'0.60';'0.70';'0.90'};
D = dir('*.mat');
for fil = 1:length(D)
    List{fil} = strrep(getfield(D,{fil,1},'name'),'.mat','');
end
FRFTyp  = {'Receptance';'Mobility';'Inertance'};
YSc     = {'dB';'Linear'};
DispTyp = {'Bode Plot';'Real/Imaginary Plot';'Nyquist Plot';'Animated Modes'};

switch length(varargin)
case 0
    option = 'initialize';
    Data.R = [];
    Data.FRFInf = [];
    Data.Lambda = [];
    Data.LengthM = [];
    Data.h = [];
    Data.M = [];
    Data.C = [];
    Data.K = [];
case 1
    option = varargin{1};
    Data = get(gcf,'UserData');
    Sn = 0;
case 2
    option = varargin{1};
    Data = get(gcf,'UserData');
    Sn = 1;
otherwise
    hh = MsgboxM('WRONG NUMBER OF INPUT ARGUMENTS!','INPUT ERROR','Error');
    uiwait(hh);
    return;
end

switch option
case 'initialize'
    h_figs = get(0,'children');
    [mm,fig] = max(strcmp(get(h_figs','Name'),'Frequency Response Function Simulator V2.0b'));
    if(mm == 1); close(fig); end
    
    h(1) = figure('Color',FrameColor, ...
        'Units','normalized',...
        'Name','Frequency Response Function Simulator V2.0b', ...
        'NumberTitle','off', ...
        'Position',FIGPOSIT, ...
        'ToolBar','none',...
        'MenuBar','none');
    h(2) = axes('Parent',h(1), ...
        'Units','normalized', ...
        'Box','on', ...
        'CameraUpVector',[0 1 0], ...
        'CLimMode','auto', ...
        'Color',[1 1 1], ...
        'ColorOrder',COrder, ...
        'FontName','Times', ...
        'FontSize',8, ...
        'LineWidth',1, ...
        'Position',FigPosUpper, ...
        'XColor',[0 0 0], ...
        'XGrid','on', ...
        'XLimMode','auto', ...
        'XTickLabelMode','auto', ...
        'XTickMode','auto', ...
        'YColor',[0 0 0], ...
        'YGrid','on', ...
        'YLimMode','auto', ...
        'YTickLabelMode','auto', ...
        'YTickMode','auto', ...
        'ZColor',[0 0 0]);
    x = get(gca,'XLim');
    y = get(gca,'YLim');
    xm = (x(2)-x(1))/2;
    ym = (y(2)-y(1))/2;
    hx = text('Parent',h(2), ...
        'Color',[0 0 0], ...
        'HandleVisibility','off', ...
        'HorizontalAlignment','center', ...
        'Position',[xm (y(1)-.15*ym)], ...
        'VerticalAlignment','top', ...
        'FontSize',8, ...
        'FontName','Times', ...
        'String','FREQUENCY [Hz]');
    set(h(2),'XLabel',hx);
    hy = text('Parent',h(2), ...
        'Color',[0 0 0], ...
        'HandleVisibility','off', ...
        'HorizontalAlignment','center', ...
        'Position',[(x(1)-.1*xm) .99*ym], ...
        'Rotation',90, ...
        'VerticalAlignment','bottom', ...
        'FontSize',8, ...
        'FontName','Times', ...
        'String','RECEPTANCE [N/n]');
    set(h(2),'YLabel',hy);
    h(3) = axes('Parent',h(1), ...
        'Units','normalized', ...
        'Box','on', ...
        'CameraUpVector',[0 1 0], ...
        'CLimMode','auto', ...
        'Color',[1 1 1], ...
        'ColorOrder',COrder, ...
        'FontName','Times', ...
        'FontSize',8, ...
        'LineWidth',1, ...
        'Position',FigPosLower, ...
        'XColor',[0 0 0], ...
        'XGrid','on', ...
        'XLimMode','auto', ...
        'XTickLabelMode','auto', ...
        'XTickMode','auto', ...
        'YColor',[0 0 0], ...
        'YGrid','on', ...
        'YLimMode','auto', ...
        'YTickLabelMode','auto', ...
        'YTickMode','auto', ...
        'ZColor',[0 0 0]);
    x = get(gca,'XLim');
    y = get(gca,'YLim');
    xm = (x(2)-x(1))/2;
    ym = (y(2)-y(1))/2;
    hx = text('Parent',h(3), ...
        'Color',[0 0 0], ...
        'HandleVisibility','off', ...
        'HorizontalAlignment','center', ...
        'Position',[xm (y(1)-.15*ym)], ...
        'VerticalAlignment','top', ...
        'FontSize',8, ...
        'FontName','Times', ...
        'String','FREQUENCY [Hz]');
    set(h(3),'XLabel',hx);
    hy = text('Parent',h(3), ...
        'Color',[0 0 0], ...
        'HandleVisibility','off', ...
        'HorizontalAlignment','center', ...
        'Position',[(x(1)-.1*xm) .99*ym], ...
        'Rotation',90, ...
        'VerticalAlignment','bottom', ...
        'FontSize',8, ...
        'FontName','Times', ...
        'String','PHASE [degrees]');
    set(h(3),'YLabel',hy);
    uipanel('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'ForegroundColor',[0 .1 .6], ...
        'Position',[.01 .54 .275 .44], ...
        'FontName','Times', ...
        'FontWeight','Bold', ...
        'FontSize',10, ...
        'Title','SYSTEM DATA', ...
        'TitlePosition','centertop');

    
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',[1 1 1], ...
        'FontName','Times', ...
        'ListboxTop',1, ...
        'Position',[.02 .905 .16 .035], ...
        'String',List, ...
        'Style','popupmenu', ...
        'Min',1, ...
        'Max',3, ...
        'Tag','Data');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'Callback','FRFSimNv2b(''LOAD'');', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'FontSize',8, ...
        'FontWeight','Bold', ...
        'ListboxTop',0, ...
        'Position',[.185 .90 .09 .038], ...
        'String','LOAD', ...
        'Tag','LOAD');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'HorizontalAlignment','center', ...
        'ListboxTop',0, ...
        'Position',[.02 .855 .255 .03], ...
        'String','System Parameters', ...
        'Style','text');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',[1 1 1], ...
        'FontName','Times', ...
        'ListboxTop',1, ...
        'Position',[.02 .565 .255 .285], ...
        'String','', ...
        'Style','listbox', ...
        'Min',1, ...
        'Max',3, ...
        'Tag','SysPar');
    uipanel('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'ForegroundColor',[0 .1 .6], ...
        'Position',[.01 .07 .275 .46], ...
        'FontName','Times', ...
        'FontWeight','Bold', ...
        'FontSize',10, ...
        'Title','GRAPHICS DATA', ...
        'TitlePosition','centertop');

    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'HorizontalAlignment','center', ...
        'ListboxTop',0, ...
        'Position',[.02 .465 .12 .03], ...
        'String','FRFs', ...
        'Style','text');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'Callback','FRFSimNv2b(''FRFs'');', ...
        'BackgroundColor',[1 1 1], ...
        'FontName','Times', ...
        'ListboxTop',1, ...
        'Position',[.02 .255 .12 .205], ...
        'String','', ...
        'Style','listbox', ...
        'Min',1, ...
        'Max',3, ...
        'Tag','FRFs');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'HorizontalAlignment','center', ...
        'ListboxTop',0, ...
        'Position',[.155 .465 .12 .03], ...
        'String','Modes', ...
        'Style','text');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'Callback','FRFSimNv2b(''Modes'');', ...
        'BackgroundColor',[1 1 1], ...
        'FontName','Times', ...
        'ListboxTop',1, ...
        'Position',[.155 .255 .12 .205], ...
        'String','', ...
        'Style','listbox', ...
        'Min',1, ...
        'Max',3, ...
        'Tag','Modes');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'HorizontalAlignment','left', ...
        'ListboxTop',0, ...
        'Position',[.02 .2 .06 .03], ...
        'String','FRF Type', ...
        'Style','text');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',[1 1 1], ...
        'FontName','Times', ...
        'ListboxTop',1, ...
        'Position',[.12 .205 .155 .035], ...
        'String',FRFTyp, ...
        'Style','popupmenu', ...
        'Min',1, ...
        'Max',1, ...
        'Tag','FRFType');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'HorizontalAlignment','left', ...
        'ListboxTop',0, ...
        'Position',[.02 .145 .075 .03], ...
        'String','Display Type', ...
        'Style','text');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'Callback','FRFSimNv2b(''DispType'');', ...
        'BackgroundColor',[1 1 1], ...
        'FontName','Times', ...
        'ListboxTop',1, ...
        'Position',[.12 .15 .155 .035], ...
        'String',DispTyp, ...
        'Style','popupmenu', ...
        'Min',1, ...
        'Max',1, ...
        'Tag','DispType');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'HorizontalAlignment','left', ...
        'ListboxTop',0, ...
        'Position',[.02 .1 .06 .03], ...
        'String','Y Scale', ...
        'Style','text');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'BackgroundColor',[1 1 1], ...
        'FontName','Times', ...
        'ListboxTop',1, ...
        'Position',[.12 .095 .155 .035], ...
        'String',YSc, ...
        'Style','popupmenu', ...
        'Min',1, ...
        'Max',1, ...
        'Tag','YScale');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'Callback','FRFSimNv2b(''PLOT'');', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'FontSize',11, ...
        'FontWeight','Bold', ...
        'ListboxTop',0, ...
        'Position',[.06 .005 .175 .05], ...
        'String','PLOT', ...
        'Tag','PLOT');
    uicontrol('Parent',h(1), ...
        'Units','normalized', ...
        'HorizontalAlignment','center', ...
        'Callback','FRFSimNv2b(''PLOT'',1);', ...
        'CData',SnapData, ...
        'ToolTipString','Snapshot', ...
        'BackgroundColor',FrameColor, ...
        'FontName','Times', ...
        'ListboxTop',0, ...
        'Position',[.945 .93 .035 .04], ...
        'String','', ...
        'Tag','Snap');
    
    Data.h = h;
    set(gcf,'UserData',Data)
    
case 'DispType'
    if(get(findobj(gcbf,'Tag','DispType'),'Value') ~= 1)
        set(findobj(gcbf,'Tag','YScale'),'Value',2)
        set(findobj(gcbf,'Tag','YScale'),'Enable','off')
    else
        set(findobj(gcbf,'Tag','YScale'),'Enable','on')
    end   
    valin = get(findobj(gcbf,'Tag','Modes'),'Value');
    if(valin ~= 1)
        valout = [1 valin];
        set(findobj(gcbf,'Tag','Modes'),'Value',1)
    end
    
case 'Modes'
    valin = get(findobj(gcbf,'Tag','Modes'),'Value');
    if(get(findobj(gcbf,'Tag','DispType'),'Value') ~= 4)
        if(valin ~= 1)
            valout = [1 valin];
            set(findobj(gcbf,'Tag','Modes'),'Value',valout)
        end
    end

case 'FRFs'
    if(length(get(findobj(gcbf,'Tag','FRFs'),'Value')) > 1)
        set(findobj(gcbf,'Tag','Modes'),'Value',1)
        set(findobj(gcbf,'Tag','Modes'),'Enable','off')
    else
        set(findobj(gcbf,'Tag','Modes'),'Enable','on')
    end   

case 'LOAD'
    
    clear M C K
    Data = get(gcf,'UserData');
    FNVal = get(findobj(gcbf,'Tag','Data'),'Value');
    load([List{FNVal} '.mat'])
    %     Fid = fopen([List{FNVal} '.sim'],'r');
    %     eval(fgetl(Fid));
    %     eval(fgetl(Fid));
    %     eval(fgetl(Fid));
    %     fclose(Fid);
    
    DispTyp = {'Bode Plot';'Real/Imaginary Plot';'Nyquist Plot';'Animated Modes'};

    if length(M) == 1
        set(findobj(gcbf,'Tag','DispType'),'Value',1)
        set(findobj(gcbf,'Tag','DispType'),'String',DispTyp(1:3))
    else
        set(findobj(gcbf,'Tag','DispType'),'String',DispTyp)
    end

    FRFText = {};
    count = 0;
    for res = 1:length(M)
        for inp = res:length(M)
            count = count+1;
            FRFInf(count,1:2) = [res inp];
            FRFTAux = ['H(' num2str(res) ',' num2str(inp) ')'];
            FRFText(count) = {FRFTAux};
        end
     end
    set(findobj(gcbf,'Tag','FRFs'),'String',FRFText);
    set(findobj(gcbf,'Tag','FRFs'),'Value',1);
    
    Z = zeros(size(M));
    
    %    Form 2N x 2N state space equation.  
    A = [Z M; M C];
    B = [-M Z; Z K];
    [x,d] = eig(B,-A);
    
    % Sort Modal Frequencies  
    orig_lambda = diag(d);
    [~,I] = sort(imag(orig_lambda));
    I = cat(1,flipud(I(1:end/2)),I(end/2+1:end));
    lambda = orig_lambda(I);
    xx = x(:,I);
    
    ModesText(1) = {'All'};
    DampingText(1) = {''};
    for mod = 1:length(M)
        Modes = [num2str(mod) ' - ' num2str(abs(lambda(mod+length(M))/(2*pi))) ' Hz'];
        ModesText(mod+1) = {Modes};
    end
    
    set(findobj(gcbf,'Tag','Modes'),'String',ModesText);
    set(findobj(gcbf,'Tag','Modes'),'Value',1);
    
    %     Normalize x matrix to real vectors if possible
%    for ii = 1:length(A)
%        xx(1:length(A),ii)=xx(1:length(A),ii)./xx(length(M)+1,ii);
%    end
    
    %     Compute 'modal a' and 'modal b' matrix
    ma = xx.'*A*xx;
%     mb = xx.'*B*xx;

    %     Extract modal vectors from state-space formulation
    psi(1:length(M),:) = xx(length(M)+1:length(A),:);
    
    %      Calculate residue matrices
    for mod = 1:length(A)
        R(1:length(M),1:length(M),mod) = psi(:,mod)*psi(:,mod).'./ma(mod,mod);
    end
    
    Data.R = R;
    Data.FRFInf = FRFInf;
    Data.Lambda = lambda;
    Data.LengthM = length(M);
    Data.M = M;
    Data.C = C;
    Data.K = K;
    Data.Modes = psi;
    
    set(gcf,'UserData',Data);
    
    if all(all(abs(C/M*K-K/M*C) < 1e-5))
        if all(all(C==0))
            PropText = 'CONSERVATIVE SYSTEM';
        else
            PropText = 'PROPORTIONAL DAMPING';
        end
    else
        PropText = 'NON PROPORTIONAL DAMPING';
    end

    NaturalFreq = [num2str(abs(lambda(length(M)+1:2*length(M)))/(2*pi))];
    Damping = [num2str(-100*real(lambda(length(M)+1:2*length(M)))./abs(lambda(length(M)+1:2*length(M))),3)];
    SysParText = {'SYSTEM ORDER:'   ; num2str(length(M),2); ''; ...
            'MASS MATRIX'     ; num2str(M,5); ''; ...
            'DAMPING MATRIX'  ; num2str(C,5); ''; ...
            'STIFFNESS MATRIX'; num2str(K,5); ''; ...
            'NATURAL FREQUENCIES [Hz]'; NaturalFreq; ''; ...
            ['DAMPING RATIOS [%] - ' PropText]; Damping};
    set(findobj(gcbf,'Tag','SysPar'),'String',SysParText);
    
    psi1 = psi/max(max(abs(psi)));
    for modl = 1:length(M)
        for modc = 1:2*length(M)
            EigenV{modl,modc} = [num2str(psi1(modl,modc),'%5.3f') '  '];
        end
    end

    NatFreq = abs(lambda(length(M)+1:2*length(M)))/(2*pi);
    Zeta    = -100*real(lambda(length(M)+1:2*length(M)))./abs(lambda(length(M)+1:2*length(M)));
    
    for mode = 1:length(M)
        fprintf('\n \n   *************************** Mode # %d *************************** \n ',mode);
        fprintf('\n       Natural Frequency = %5.2f Hz   ',NatFreq(mode));
        fprintf('\n       Damping Ratio = %4.1f %   ',Zeta(mode));

% Max value = 1 and phase first element = 0 deg.
        MPhir_af = [abs(psi(:,mode)/max(psi(:,mode)))'
            (180/pi)*angle(psi(:,mode)/psi(1,mode))'
            abs(psi(:,mode+length(M))/max(psi(:,mode+length(M))))'
            (180/pi)*angle(psi(:,mode+length(M))/psi(1,mode+length(M)))'];

        MPhir_ri = [real(psi(:,mode))'
            imag(psi(:,mode))'
            real(psi(:,mode+length(M)))'
            imag(psi(:,mode+length(M)))'];
        fprintf('\n \n                                Eigenvectors   ');
        fprintf('\n                                ------------   ');
        fprintf('\n                 Phi                               Phi*');
        fprintf('\n            Abs          Angle                  Abs          Angle \n');
        fprintf('       %10.6f     %10.6f           %10.6f     %10.6f \n',MPhir_af);
        fprintf('\n \n            Real          Imag                  Real          Imag \n');
        fprintf('       %10.6f     %10.6f           %10.6f     %10.6f \n',MPhir_ri);
        clear MPhir;
    end
    
case 'PLOT'
    Data = get(gcf,'UserData');
    lambda = Data.Lambda;
    h = Data.h;
    
    if(get(findobj(gcbf,'Tag','DispType'),'Value') ~= 4) % Plot FRFs
        R = Data.R;
        FRFInf = Data.FRFInf;
        lM = Data.LengthM;

        set(findobj(gcbf,'Tag','YScale'),'Enable','on')
        set(findobj(gcbf,'Tag','FRFType'),'Enable','on')
        set(findobj(gcbf,'Tag','FRFs'),'Enable','on')

        mfn = max(abs(lambda));

        InpResp = FRFInf(get(findobj(gcbf,'Tag','FRFs'),'Value'),:);
        omhz=linspace(.01,1.2*(ceil(mfn/(2*pi*1))),50001);
        om=omhz*2*pi;

        H = zeros(size(InpResp,1),length(om));
        om1 = zeros(size(InpResp,1),length(om));
        for nFRFs = 1:size(InpResp,1)
            HAux = zeros(size(om));
            for mod = 1:2*lM
                HAux = HAux+(R(InpResp(nFRFs,1),InpResp(nFRFs,2),mod)./(j.*om-lambda(mod)));
            end
            H(nFRFs,:) = HAux;
            om1(nFRFs,:) = om;
        end
        if(get(findobj(gcbf,'Tag','FRFType'),'Value') == 2)
            H = 1i*om1.*H;
        elseif(get(findobj(gcbf,'Tag','FRFType'),'Value') == 3)
            H = ((1i*om1).^2).*H;
        end

        if(Sn == 1)
            h(1) = figure;
            set(h(1),'Color','w');
            if(get(findobj(gcbf,'Tag','DispType'),'Value') < 3)
                h(3) = subplot(2,1,2);
                h(2) = subplot(2,1,1);
            end
        else
            axes(h(3))
            cla reset;
            if(get(findobj(gcbf,'Tag','DispType'),'Value') == 3)
                set(h(2),'Position',FigPosNyqui);
                set(h(3),'Visible','off')
            else
                set(h(2),'Position',FigPosUpper);
                set(h(3),'Visible','on')
            end
            axes(h(2))
            cla reset;
        end

        if(get(findobj(gcbf,'Tag','YScale'),'Value') == 1)
            plot(omhz,20*log10(abs(H)));
            if(get(findobj(gcbf,'Tag','FRFType'),'Value') == 2)
                ylabel('MOBILITY [dBrel(1m/N.s)]','FontSize',8,'FontName','Times');
            elseif(get(findobj(gcbf,'Tag','FRFType'),'Value') == 3)
                ylabel('INERTANCE [dBrel(1m/N.s2)]','FontSize',8,'FontName','Times');
            else
                ylabel('RECEPTÂNCIA [dBrel(1m/N)]','FontSize',8,'FontName','Times');
            end
        else
            if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                plot(omhz,abs(H));
            elseif(get(findobj(gcbf,'Tag','DispType'),'Value') == 2)
                plot(omhz,real(H));
            else
                plot(real(H)',imag(H)');
                axis equal;
                %            axis square;
            end
            if(get(findobj(gcbf,'Tag','FRFType'),'Value') == 2)
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    ylabel('MAG - MOBILITY [m/N.s]','FontSize',8,'FontName','Times');
                elseif(get(findobj(gcbf,'Tag','DispType'),'Value') == 2)
                    ylabel('REAL PART - MOBILITY [m/N.s]','FontSize',8,'FontName','Times');
                else
                    ylabel('IMAGINARY PART - MOBILITY [m/N.s]','FontSize',8,'FontName','Times');
                end
            elseif(get(findobj(gcbf,'Tag','FRFType'),'Value') == 3)
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    ylabel('MAG - INERTANCE [m/N.s2]','FontSize',8,'FontName','Times');
                elseif(get(findobj(gcbf,'Tag','DispType'),'Value') == 2)
                    ylabel('REAL PART - INERTANCE [m/N.s2]','FontSize',8,'FontName','Times');
                else
                    ylabel('IMAGINARY PART - INERTANCE [m/N.s2]','FontSize',8,'FontName','Times');
                end
            else
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    ylabel('MAG - RECEPTANCE [m/N]','FontSize',8,'FontName','Times');
                elseif(get(findobj(gcbf,'Tag','DispType'),'Value') == 2)
                    ylabel('REAL PART - RECEPTANCE [m/N]','FontSize',8,'FontName','Times');
                else
                    ylabel('IMAGINARY PART - RECEPTANCE [m/N]','FontSize',8,'FontName','Times');
                end
            end
        end
        if(get(findobj(gcbf,'Tag','DispType'),'Value') == 3)
            if(get(findobj(gcbf,'Tag','FRFType'),'Value') == 2)
                xlabel('REAL PART - MOBILITY [m/N.s]','FontSize',8,'FontName','Times');
            elseif(get(findobj(gcbf,'Tag','FRFType'),'Value') == 3)
                xlabel('REAL PART - INERTANCE [m/N.s2]','FontSize',8,'FontName','Times');
            else
                xlabel('REAL PART - RECEPTANCE [m/N]','FontSize',8,'FontName','Times');
            end
        else
            xlabel('FREQUÊNCIA [Hz]','FontSize',8,'FontName','Times');
        end
        FRFText = get(findobj(gcbf,'Tag','FRFs'),'String');
        set(get(h(2),'Children'),'LineWidth',1.);
        set(h(2),'ColorOrder',COrder);
        set(h(2),'FontSize',8);
        legend(FRFText{get(findobj(gcbf,'Tag','FRFs'),'Value')});
        grid on
        if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
            tit = ['FUNÇÃO DE RESPOSTA EM FREQUÊNCIA - BODE PLOT'];
        elseif(get(findobj(gcbf,'Tag','DispType'),'Value') == 2)
            tit = ['FUNÇÃO DE RESPOSTA EM FREQUÊNCIA - REAL & IMAGINARY PLOT'];
        else
            tit = ['FUNÇÃO DE RESPOSTA EM FREQUÊNCIA - NYQUIST PLOT'];
        end
        title(tit,'FontSize',10,'FontName','Times','FontWeight','bold')
        box on
        ModesP = get(findobj(gcbf,'Tag','Modes'),'Value');
        if(length(ModesP) > 1)
            lims = axis;
            hold on
            nFRFs = 1;
            HM = zeros(length(ModesP)-1,length(om));
            om2 = zeros(length(ModesP)-1,length(om));
            for mod = 1:length(ModesP)-1
                HM(mod,:) = (R(InpResp(nFRFs,1),InpResp(nFRFs,2),ModesP(mod+1)-1+lM)./(j.*om-lambda(ModesP(mod+1)-1+lM)));
                om2(mod,:) = om;
            end
            if(get(findobj(gcbf,'Tag','FRFType'),'Value') == 2)
                HM = 1i*om2.*HM;
            elseif(get(findobj(gcbf,'Tag','FRFType'),'Value') == 3)
                HM = ((1i*om2).^2).*HM;
            end
            if(get(findobj(gcbf,'Tag','YScale'),'Value') == 1)
                plot(omhz,20*log10(abs(HM)),'--r');
            else
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    plot(omhz,abs(HM),'--r');
                elseif(get(findobj(gcbf,'Tag','DispType'),'Value') == 2)
                    plot(omhz,real(HM),'--r');
                else
                    plot(real(HM)',imag(HM)','--r');
                end
            end
            hold off
            axis(lims);
        end

        if(get(findobj(gcbf,'Tag','DispType'),'Value') ~= 3)
            axes(h(3))
            if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                plot(omhz,angle(H)*180/pi);
                lims = axis;
                axis([lims(1) lims(2) -180 180]);
                set(gca,'YTick',[-180:60:180])
            else
                plot(omhz,imag(H));
            end
            set(get(h(3),'Children'),'LineWidth',1.);
            set(h(3),'ColorOrder',COrder);
            set(h(3),'FontSize',8);
            grid on
            xlabel('FREQUÊNCIA [Hz]','FontSize',8,'FontName','Times');
            if(get(findobj(gcbf,'Tag','FRFType'),'Value') == 2)
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    ylabel('PHASE - MOBILITY [degrees]','FontSize',8,'FontName','Times');
                else
                    ylabel('IMAG PART - MOBILITY [m/N.s]','FontSize',8,'FontName','Times');
                end
            elseif(get(findobj(gcbf,'Tag','FRFType'),'Value') == 3)
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    ylabel('PHASE - INERTANCE [degrees]','FontSize',8,'FontName','Times');
                else
                    ylabel('IMAG PART - INERTANCE [m/N.s2]','FontSize',8,'FontName','Times');
                end
            else
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    ylabel('FASE - RECEPTÂNCIA [graus]','FontSize',8,'FontName','Times');
                else
                    ylabel('IMAG PART - RECEPTANCE [m/N]','FontSize',8,'FontName','Times');
                end
            end

            box on
            if(length(ModesP) > 1)
                lims = axis;
                hold on
                if(get(findobj(gcbf,'Tag','DispType'),'Value') == 1)
                    plot(omhz,angle(HM)*180/pi,'--r');
                else
                    plot(omhz,imag(HM),'--r');
                end
                hold off
                axis(lims);
            end
        end
    else
        Modes = Data.Modes;

        set(findobj(gcbf,'Tag','YScale'),'Enable','off')
        set(findobj(gcbf,'Tag','FRFType'),'Enable','off')
        set(findobj(gcbf,'Tag','FRFs'),'Enable','off')

        SelMode = get(findobj(gcbf,'Tag','Modes'),'Value');
        if length(SelMode) > 1
            SelMode = SelMode(1);
        end
        if SelMode == 1
            SelMode = 2;
            set(findobj(gcbf,'Tag','Modes'),'Value',SelMode)
        end

        md(:,1) = 0.4*abs(Modes(:,SelMode-1))/max(abs(Modes(:,SelMode-1)));
        md(:,2) = angle(Modes(:,SelMode-1));
        NaturalFreq = abs(lambda(end/2+1:end))/(2*pi);
        Damping = -100*real(lambda(end/2+1:end))./abs(lambda(end/2+1:end));
        if Damping <= 1e-5
            Damping = 0;
        end

        if(Sn == 1)
            h(1) = figure;
            set(h(1),'Color','w');
%             plot(linspace(0.02,0.98,size(md,1)/2),-0.5+0.98*md(1:size(md,1)/2,1).*sin(2*pi + md(1:size(md,1)/2,2)), ...
%                 '-bs','LineWidth',1,'MarkerEdgeColor','k',...
%                 'MarkerFaceColor','r', 'MarkerSize',8)
%             hold on
%             plot(linspace(0.02,0.98,size(md,1)/2),0.5+0.98*md(size(md,1)/2+1:size(md,1),1).*sin(2*pi + md(size(md,1)/2+1:size(md,1),2)), ...
%                 '-bs','LineWidth',1,'MarkerEdgeColor','k',...
%                 'MarkerFaceColor','r', 'MarkerSize',8)
            plot(linspace(0.02,0.98,2),0.5+0.98*[md(1,1).*sin(2*pi + md(1,2)) 0], ...
                '-bs','LineWidth',1,'MarkerEdgeColor','k',...
                'MarkerFaceColor','r', 'MarkerSize',8)
            hold on
            plot(linspace(0.02,0.98,2),0.5-0.98*[md(1,1).*sin(2*pi + md(1,2)) 0], ...
                '-bs','LineWidth',1,'LineStyle','--','MarkerEdgeColor','k',...
                'MarkerFaceColor','r', 'MarkerSize',8)
            plot(linspace(0.02,0.49,2),-0.5+0.98*[md(2,1).*sin(2*pi + md(2,2)) 0], ...
                '-bs','LineWidth',1,'MarkerEdgeColor','k',...
                'MarkerFaceColor','r', 'MarkerSize',8)
            plot(linspace(0.02,0.49,2),-0.5-0.98*[md(2,1).*sin(2*pi + md(2,2)) 0], ...
                '-bs','LineWidth',1,'LineStyle','--','MarkerEdgeColor','k',...
                'MarkerFaceColor','r', 'MarkerSize',8)
            plot([0 1],[0.5 0.5],'--k')
            plot([0 .5],[-0.5 -0.5],'--k')
            hold off
            axis([0 1 -1 1])
            axis off
            title(['Mode: ' num2str(SelMode-1) ' - \Omega_{n} = ' ...
                num2str(NaturalFreq(SelMode-1),4) 'Hz - \zeta = ' num2str(Damping(SelMode-1),3) '%'], ...
                'FontWeight','Demi')
        else
            axes(h(3))
            cla reset;
            set(h(2),'Position',FigPosNyqui);
            set(h(3),'Visible','off')
            axes(h(2))
            cla reset


            nframes = 60;
            for nf = 1:nframes
               plot(linspace(0.02,0.98,2),0.5+0.98*[md(1,1).*sin(2*pi*nf/nframes + md(1,2)) 0], ...
                '-bs','LineWidth',1,'MarkerEdgeColor','k',...
                'MarkerFaceColor','r', 'MarkerSize',8)
            hold on
            plot(linspace(0.02,0.49,2),-0.5+0.98*[md(2,1).*sin(2*pi*nf/nframes + md(2,2)) 0], ...
                '-bs','LineWidth',1,'MarkerEdgeColor','k',...
                'MarkerFaceColor','r', 'MarkerSize',8)
            plot([0 1],[0.5 0.5],'--k')
            plot([0 0.5],[-0.5 -0.5],'--k')

            axis([0 1 -1 1])
            axis off
            title(['Mode: ' num2str(SelMode-1) ' - \Omega_{n} = ' ...
                num2str(NaturalFreq(SelMode-1),4) 'Hz - \zeta = ' num2str(Damping(SelMode-1),3) '%'], ...
                'FontWeight','Demi','FontSize',10)
            
            F(nf) = getframe;
            hold off
            end
            cla

            movie(F,4,20);
            movie2avi(F,'modo1.avi','compression','none')
        end
    end

end

function [SnapData] = SnapshotCData()

SnapData(:,:,1) = [
  191  191  191  191  191  191  191  191  191  127  127  127  127  127  191  191  191  191  191  191  191   191  191  191
  191  191  191  191  191  191  191  191  191  127  191  255  191  255  127  191  191  191  127  127  127     0    0  191
  191  191    0    0    0  127  191  191  127  191  255  191  255  191  255  127  191  191  127  191  255   127    0  191
  127  127  127  127  127  127  127  127  127  127  127  127    0    0    0    0    0    0    0    0    0     0    0  127
  127  127    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0     0    0  127
    0  127  255  255  255  255  191  191  127  191  255  191  255  191  127  127  127  191  127  191  127   191  127  127
    0  191  127    0    0  127  127  127  255  255  127    0    0  127  255    0    0    0    0    0    0     0    0  127
    0  127  127    0    0  127  127  255  255  127    0    0    0    0  127  191    0    0    0  127    0   127    0  127
    0  191    0  127  127    0  127  255    0    0    0  255  191    0    0  127  191    0  127    0  127     0    0  127
    0  127  127    0    0    0  191  255    0    0  255    0    0    0    0    0  127    0    0  127    0   127    0  127
    0  191  127    0    0    0  191  255    0    0  255    0    0    0    0    0  191    0    0    0  127     0    0  127
    0  127    0  127  127    0  127  255    0    0  191    0    0    0    0    0  191    0    0  127    0   127    0  127
    0  191  127    0    0  127  127  255  255    0    0    0    0    0    0  127  127    0    0    0  127     0    0  127
    0  127  127    0    0  127  127  127  255  255    0    0    0    0  127  255    0    0    0  127    0   127    0  127
    0  191  255  255  255  191  191  127  127  191  255  191  255  191  191    0    0  191  127  191  127   191    0  127
  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127   127  127  127
    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0     0    0  127];

SnapData(:,:,2) = [
  191  191  191  191  191  191  191  191  191  127  127  127  127  127  191  191  191  191  191  191  191   191  191  191
  191  191  191  191  191  191  191  191  191  127  191  255  191  255  127  191  191  191  127  127  127     0    0  191
  191  191    0    0    0  127  191  191  127  191  255  191  255  191  255  127  191  191  127  191  255   127    0  191
  127  127  127  127  127  127  127  127  127  127  127  127    0    0    0    0    0    0    0    0    0     0    0  127
  127  127    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0     0    0  127
    0  127  255  255  255  255  191  191  127  191  255  191  255  191  127  127  127  191  127  191  127   191  127  127
    0  191  127    0    0  127  127  127  255  255  127    0    0  127  255    0    0    0    0    0    0     0    0  127
    0  127  127    0    0  127  127  255  255  127    0    0    0    0  127  191    0    0    0  127    0   127    0  127
    0  191    0  127  127    0  127  255    0    0    0  255  191    0    0  127  191    0  127    0  127     0    0  127
    0  127  127    0    0    0  191  255    0    0  255    0    0    0    0    0  127    0    0  127    0   127    0  127
    0  191  127    0    0    0  191  255    0    0  255    0    0    0    0    0  191    0    0    0  127     0    0  127
    0  127    0  127  127    0  127  255    0    0  191    0    0    0    0    0  191    0    0  127    0   127    0  127
    0  191  127    0    0  127  127  255  255    0    0    0    0    0    0  127  127    0    0    0  127     0    0  127
    0  127  127    0    0  127  127  127  255  255    0    0    0    0  127  255    0    0    0  127    0   127    0  127
    0  191  255  255  255  191  191  127  127  191  255  191  255  191  191    0    0  191  127  191  127   191    0  127
  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127   127  127  127
    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0     0    0  127];

SnapData(:,:,3) = [
  191  191  191  191  191  191  191  191  191  127  127  127  127  127  191  191  191  191  191  191  191   191  191  191
  191  191  191  191  191  191  191  191  191  127  191  255  191  255  127  191  191  191  127  127  127     0    0  191
  191  191    0    0    0  127  191  191  127  191  255  191  255  191  255  127  191  191  127  191  255   127    0  191
  127  127  127  127  127  127  127  127  127  127  127  127    0    0    0    0    0    0    0    0    0     0    0  127
  127  127    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0     0    0  127
    0  127  255  255  255  255  191  191  127  191  255  191  255  191  127  127  127  191  127  191  127   191  127  127
    0  191  127    0    0  127  127  127  255  255  127    0    0  127  255    0    0    0    0    0    0     0    0  127
    0  127  127    0    0  127  127  255  255  127    0    0    0    0  127  191    0    0    0  127    0   127    0  127
    0  191    0  127  127    0  127  255    0    0    0  255  191    0    0  127  191    0  127    0  127     0    0  127
    0  127  127    0    0    0  191  255    0    0  255    0    0    0    0    0  127    0    0  127    0   127    0  127
    0  191  127    0    0    0  191  255    0    0  255    0    0    0    0    0  191    0    0    0  127     0    0  127
    0  127    0  127  127    0  127  255    0    0  191    0    0    0    0    0  191    0    0  127    0   127    0  127
    0  191  127    0    0  127  127  255  255    0    0    0    0    0    0  127  127    0    0    0  127     0    0  127
    0  127  127    0    0  127  127  127  255  255    0    0    0    0  127  255    0    0    0  127    0   127    0  127
    0  191  255  255  255  191  191  127  127  191  255  191  255  191  191    0    0  191  127  191  127   191    0  127
  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127  127   127  127  127
    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0     0    0  127];

SnapData = SnapData/max(max(max(SnapData)));
